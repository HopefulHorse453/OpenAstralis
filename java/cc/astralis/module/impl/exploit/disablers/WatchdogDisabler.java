package cc.astralis.module.impl.exploit.disablers;

import cc.astralis.event.EventTarget;
import cc.astralis.event.events.impl.network.PacketEvent;
import cc.astralis.event.types.EventModes;
import cc.astralis.module.Module;
import cc.astralis.module.SubModule;
import net.minecraft.network.protocol.game.ServerboundMovePlayerPacket;
import net.minecraft.network.protocol.game.ServerboundUseItemOnPacket;

public class WatchdogDisabler extends SubModule {
    private float playerYaw;
    private float deltaYaw;
    private float lastPlacedDeltaYaw;
    private boolean rotated = false;

    public WatchdogDisabler(Module module) {
        super(module,"Watchdog");
    }

    @EventTarget
    public void onPacket(PacketEvent event) {
        if (event.getEventMode() == EventModes.SEND && !event.isCancelled()) {
            if (event.getPacket() instanceof ServerboundMovePlayerPacket.Rot ||
                    event.getPacket() instanceof ServerboundMovePlayerPacket.PosRot) {
                ServerboundMovePlayerPacket packet = (ServerboundMovePlayerPacket) event.getPacket();

                float lastPlayerYaw = playerYaw;
                playerYaw = packet.getYRot(mc.player.getYRot());
                deltaYaw = Math.abs(playerYaw - lastPlayerYaw);
                rotated = true;

                if (deltaYaw > 2) {
                    float xDiff = Math.abs(deltaYaw - lastPlacedDeltaYaw);
                    if (xDiff < 0.0001) {
                        if (packet instanceof ServerboundMovePlayerPacket.Rot lookPacket) {
                            ServerboundMovePlayerPacket newPacket = new ServerboundMovePlayerPacket.Rot(
                                    lookPacket.getYRot(0) + 0.0002F,
                                    lookPacket.getXRot(0),
                                    lookPacket.isOnGround(), mc.player.horizontalCollision
                            );
                            event.setPacket(newPacket);
                        } else if (packet instanceof ServerboundMovePlayerPacket.PosRot fullPacket) {
                            ServerboundMovePlayerPacket newPacket = new ServerboundMovePlayerPacket.PosRot(
                                    fullPacket.getX(0),
                                    fullPacket.getY(0),
                                    fullPacket.getZ(0),
                                    fullPacket.getYRot(0) + 0.0002F,
                                    fullPacket.getXRot(0),
                                    fullPacket.isOnGround(), mc.player.horizontalCollision
                            );

                            event.setPacket(newPacket);
                        }
                    }
                }
            } else if (event.getPacket() instanceof ServerboundUseItemOnPacket) {
                if (rotated) {
                    lastPlacedDeltaYaw = deltaYaw;
                    rotated = false;
                }
            }
        }
    }
}
