package cc.astralis.module.impl.exploit.disablers;

import cc.astralis.Astralis;
import cc.astralis.event.EventTarget;
import cc.astralis.event.events.impl.game.UpdateEvent;
import cc.astralis.event.events.impl.game.WorldChangeEvent;
import cc.astralis.event.events.impl.network.PacketEvent;
import astralis.mixin.accessor.network.PlayerMoveC2SPacketAccessor;
import cc.astralis.module.Module;
import cc.astralis.module.SubModule;
import cc.astralis.module.impl.combat.KillauraModule;
import cc.astralis.module.impl.movement.FlightModule;
import cc.astralis.module.impl.movement.SpeedModule;
import cc.astralis.ui.notifications.render.Notification;
import cc.astralis.ui.notifications.NotificationBuilder;
import cc.astralis.property.properties.BooleanProperty;
import cc.astralis.util.network.PacketUtil;
import cc.astralis.util.render.ChatUtil;
import java.util.LinkedHashSet;
import net.minecraft.client.multiplayer.PlayerInfo;
import net.minecraft.core.registries.BuiltInRegistries;
import net.minecraft.network.protocol.common.ClientboundKeepAlivePacket;
import net.minecraft.network.protocol.common.ClientboundPingPacket;
import net.minecraft.network.protocol.game.ClientboundPlayerPositionPacket;
import net.minecraft.network.protocol.game.ClientboundSoundPacket;
import net.minecraft.network.protocol.game.ServerboundMovePlayerPacket;
import net.minecraft.network.protocol.game.ServerboundSwingPacket;
import net.minecraft.resources.ResourceLocation;
import net.minecraft.world.entity.LivingEntity;

public class CubecraftDisabler extends SubModule {
    private final BooleanProperty groundSpoofDisabler = new BooleanProperty("Ground Spoof Disabler", true);
    private final BooleanProperty autoResync = new BooleanProperty("Auto Resync", false);
    private final BooleanProperty warning = new BooleanProperty("Warning", true);

    private final LinkedHashSet<PacketUtil.TimedPacket> packetQueue = new LinkedHashSet<>();
    private boolean didSendNotification = false;

    public CubecraftDisabler(Module module) {
        super(module,"Cubecraft");
        this.registerPropertiesToParentClass(warning, groundSpoofDisabler, autoResync);
    }

    @Override
    public void onDisable() {
        this.sendAllPackets(true);
        didReleased = false;

        super.onDisable();
    }

    long lastSwingTime = 0;
    boolean swingPendingConfirm = false;
    boolean hasMissed = false;
    LivingEntity targetWhenSwang = null;
    boolean didReleased = false;

    @EventTarget
    public void onPacket(PacketEvent event) {
        if (autoResync.getProperty()) {
            var killAura = Astralis.getInstance().getModuleManager().getModule(KillauraModule.class);
            if (event.getPacket() instanceof ServerboundSwingPacket && killAura.target != null) {
                lastSwingTime = System.currentTimeMillis();
                swingPendingConfirm = true;
                hasMissed = false;
                targetWhenSwang = killAura.target;
                didReleased = false;

                ChatUtil.printDebug("§ePlayer swung at: " + targetWhenSwang.getName().getString());
            }

            if (event.getPacket() instanceof ClientboundSoundPacket packet) {
                ResourceLocation sound = BuiltInRegistries.SOUND_EVENT.getKey(packet.getSound().value());
                if (sound != null && sound.getPath().contains("hurt") && swingPendingConfirm && targetWhenSwang != null) {
                    long timeSinceSwing = System.currentTimeMillis() - lastSwingTime;

                    double soundX = packet.getX();
                    double soundY = packet.getY();
                    double soundZ = packet.getZ();

                    double dx = targetWhenSwang.getX() - soundX;
                    double dy = targetWhenSwang.getY() - soundY;
                    double dz = targetWhenSwang.getZ() - soundZ;
                    double distSq = dx * dx + dy * dy + dz * dz;

                    if (timeSinceSwing < 150 && distSq < Astralis.getInstance().getModuleManager().getModule(KillauraModule.class).attackRange.getProperty().floatValue()) {
                        ChatUtil.printDebug("§aAttack confirmed on " + targetWhenSwang.getName().getString() + " via sound: " + sound);
                        swingPendingConfirm = false;
                        targetWhenSwang = null;
                        hasMissed = false;
                        didReleased = false;
                    }
                }
            }

            if (swingPendingConfirm && !hasMissed && System.currentTimeMillis() - lastSwingTime > 150) {
                hasMissed = true;
                swingPendingConfirm = false;

                if (!didReleased && targetWhenSwang != null) {
                    ChatUtil.printDebug("§cSwing missed or not confirmed on: " + targetWhenSwang.getName().getString());
                    didReleased = true;
                    sendAllPackets(true);
                }

                targetWhenSwang = null;
            }
        }

        if (event.getPacket() instanceof ClientboundPlayerPositionPacket playerPositionLookS2CPacket) {
           // this.sendAllPackets(true);

            ChatUtil.printDebug("Flag. Wait a bit before flying again.");
            Astralis.getInstance().getModuleManager().getModule(SpeedModule.class).setToggled(false);
            Astralis.getInstance().getModuleManager().getModule(FlightModule.class).setToggled(false);
        }

        if (event.getPacket() instanceof ServerboundMovePlayerPacket && groundSpoofDisabler.getProperty()) {
            PlayerMoveC2SPacketAccessor test = ((PlayerMoveC2SPacketAccessor) event.getPacket());
            test.setY(test.getY() - (test.getY() % 0.015625));
        }

        if (event.getPacket() instanceof ClientboundPingPacket || event.getPacket() instanceof ClientboundKeepAlivePacket) {
            event.setCancelled(true);

            synchronized (this.packetQueue) {
                this.packetQueue.add(new PacketUtil.TimedPacket(
                        event.getPacket(),
                        System.currentTimeMillis()));
            }
        }
    }

    @EventTarget
    public void onUpdate(UpdateEvent event) {
        if (mc.hasSingleplayerServer()) {
            getParentClass().toggle();
            return;
        }

        if (mc.getConnection() != null) {
            PlayerInfo playerListEntry = mc.getConnection().getPlayerInfo(mc.player.getUUID());
            if (playerListEntry != null) {
                if (playerListEntry.getLatency() > 500 ) {
                    if (!didSendNotification) {
                        NotificationBuilder.create()
                                .notification("Done you can now fly etc", Notification.NotificationType.INFO)
                                .duration(10000)
                                .build();
                        didSendNotification = true;
                    }
                } else if (warning.getProperty()) {
                    SpeedModule speedModule = Astralis.getInstance().getModuleManager().getModule(SpeedModule.class);
                    FlightModule flightModule = Astralis.getInstance().getModuleManager().getModule(FlightModule.class);

                    if (speedModule.isToggled()) {
                        NotificationBuilder.create()
                                .notification("Wait until disabler is finished.", Notification.NotificationType.WARNING)
                                .duration(1000)
                                .build();
                        speedModule.setToggled(false);
                    }

                    if (flightModule.isToggled()) {
                        NotificationBuilder.create()
                                .notification("Wait until disabler is finished.", Notification.NotificationType.WARNING)
                                .duration(1000)
                                .build();
                        flightModule.setToggled(false);
                    }
                }
            }
        }

        //ChatUtil.printDebug(mc.player.age);
        this.sendAllPackets(mc.player.tickCount <= 50);
    }

    @EventTarget
    public void onWorldChange(WorldChangeEvent event) {
        ChatUtil.printDebug("Please wait a moment before performing actions again.");
        this.sendAllPackets(true);
        didSendNotification = false;
        didReleased = false;
    }

    private void sendAllPackets(boolean all) {
        synchronized (this.packetQueue) {
            this.packetQueue.removeIf(data -> {
                if (all || data.time() <= System.currentTimeMillis() - (mc.player.tickCount < 150 ? 5000L : 10000L)) {
                    PacketUtil.receiveNoEvent(data.packet());
                    return true;
                }

                return false;
            });
        }
    }
}
