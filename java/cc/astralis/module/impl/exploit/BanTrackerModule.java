package cc.astralis.module.impl.exploit;

import cc.astralis.ui.notifications.NotificationBuilder;
import cc.astralis.event.EventTarget;
import cc.astralis.event.events.impl.game.UpdateEvent;
import cc.astralis.module.Category;
import cc.astralis.module.Module;
import cc.astralis.ui.notifications.render.Notification;
import cc.astralis.property.properties.NumberProperty;
import cc.astralis.util.io.ThreadUtil;
import cc.astralis.util.math.TimeUtil;
import org.json.JSONObject;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;

public class BanTrackerModule extends Module {
    private final NumberProperty delayInBetweenChecks = new NumberProperty("Delay In Between Checks", 2000, 0, 10000, 1);

    private static final String API_URL = "https://api.plancke.io/hypixel/v1/punishmentStats";
    private final TimeUtil timeUtil = new TimeUtil();
    private final TimeUtil notificationTimeUtil = new TimeUtil();
    private int oldWatchdogBans = -1, totalWatchdogBans = 0;
    private int oldStaffBans = -1, totalStaffBans = 0;

    private int watchdogBansDuringPeriod = 0;
    private int staffBansDuringPeriod = 0;

    public BanTrackerModule() {
        super(Category.EXPLOIT);
        registerProperty(delayInBetweenChecks);
    }

    @EventTarget
    public void onUpdate(UpdateEvent event) {
        ThreadUtil.runAsync((() -> {
            try {
                if (timeUtil.finished(delayInBetweenChecks.getProperty().longValue())) {
                    checkAndUpdateBans();
                }

                if (notificationTimeUtil.finished(15000)) {
                    sendBatchNotification();
                }
            } catch (Exception e) {
                e.printStackTrace();
            }
        }));
    }

    public void checkAndUpdateBans() throws Exception {
        JSONObject currStats = getCurrentStats();

        int watchdogBans = currStats.getInt("watchdog_total");
        int staffBans = currStats.getInt("staff_total");

        if (oldWatchdogBans == -1 || oldStaffBans == -1) {
            oldWatchdogBans = watchdogBans;
            oldStaffBans = staffBans;
            return;
        }

        int watchdogBanDiff = watchdogBans - oldWatchdogBans;
        int staffBanDiff = staffBans - oldStaffBans;

        if (watchdogBanDiff > 0) {
            totalWatchdogBans += watchdogBanDiff;
            watchdogBansDuringPeriod += watchdogBanDiff;
        }

        if (staffBanDiff > 0) {
            totalStaffBans += staffBanDiff;
            staffBansDuringPeriod += staffBanDiff;
        }

        oldWatchdogBans = watchdogBans;
        oldStaffBans = staffBans;

        if (watchdogBanDiff > 0 || staffBanDiff > 0) {
            notificationTimeUtil.reset();
        }
    }

    private void sendBatchNotification() {
        if (watchdogBansDuringPeriod > 0) {

            NotificationBuilder.create()
                    .notification("Watchdog Banned " + watchdogBansDuringPeriod + " player" + (watchdogBansDuringPeriod > 1 ? "s" : "") + " in the past 15 seconds" + " , total " + totalWatchdogBans,
                            Notification.NotificationType.WARNING)
                    .duration(4000)
                    .build();

            watchdogBansDuringPeriod = 0;
        }

        if (staffBansDuringPeriod > 0) {
            NotificationBuilder.create()
                    .notification("Staff Banned " + staffBansDuringPeriod + " player" + (staffBansDuringPeriod > 1 ? "s" : "") + " in the past 15 seconds" + " , total " + totalStaffBans,
                            Notification.NotificationType.WARNING)
                    .duration(4000)
                    .build();
            staffBansDuringPeriod = 0;
        }
    }

    private JSONObject getCurrentStats() throws Exception {
        URL url = new URL(API_URL);
        HttpURLConnection connection = (HttpURLConnection) url.openConnection();
        connection.setRequestMethod("GET");
        connection.setRequestProperty("User-Agent", "kwayservices.top");

        BufferedReader in = new BufferedReader(new InputStreamReader(connection.getInputStream()));
        String inputLine;
        StringBuilder content = new StringBuilder();
        while ((inputLine = in.readLine()) != null) {
            content.append(inputLine);
        }

        in.close();
        connection.disconnect();

        JSONObject jsonResponse = new JSONObject(content.toString());
        return jsonResponse.getJSONObject("record");
    }
}
