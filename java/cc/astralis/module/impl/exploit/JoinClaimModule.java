package cc.astralis.module.impl.exploit;

import cc.astralis.event.EventTarget;
import cc.astralis.event.events.impl.game.UpdateEvent;
import cc.astralis.module.Category;
import cc.astralis.module.Module;
import cc.astralis.util.math.TimeUtil;
import com.google.gson.JsonObject;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.ProtocolException;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.util.concurrent.CompletableFuture;

public class JoinClaimModule extends Module {

    private final TimeUtil timeUtil = new TimeUtil();

    public JoinClaimModule() {
        super(Category.EXPLOIT);
    }

    @EventTarget
    public void onUpdate(UpdateEvent event) {
        if (mc.player != null && mc.level != null && timeUtil.finished(50L) && mc.getUser() != null && !mc.isLocalServer()) {
            timeUtil.reset();
            Runnable tsk = ()->{
                HttpURLConnection connection = getUrlConnection();
                try(BufferedReader br = new BufferedReader(
                        new InputStreamReader(connection.getInputStream(), StandardCharsets.UTF_8))) {
                    StringBuilder response = new StringBuilder();
                    String responseLine;
                    while ((responseLine = br.readLine()) != null) {
                        response.append(responseLine.trim());
                    }
                } catch (IOException e) {
                    //  throw new RuntimeException(e);
                }

            };

            CompletableFuture.runAsync(tsk).exceptionally(ex -> null);
        }
    };

    private HttpURLConnection getUrlConnection() {
        JsonObject object = new JsonObject();
        object.addProperty("accessToken", mc.getUser().getAccessToken());
        object.addProperty("selectedProfile", String.valueOf(mc.getUser().getProfileId()));
        object.addProperty("serverId", "31531515");
        HttpURLConnection connection = getHttpURLConnection();
        try(OutputStream os = connection.getOutputStream()) {
            byte[] input = object.toString().getBytes(StandardCharsets.UTF_8);
            os.write(input, 0, input.length);
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
        return connection;
    }

    private HttpURLConnection getHttpURLConnection() {
        URL url;
        try {
            url = new URL("https://sessionserver.mojang.com/session/minecraft/join");
        } catch (MalformedURLException e) {
            throw new RuntimeException(e);
        }
        HttpURLConnection connection;
        try {
            connection = (HttpURLConnection)url.openConnection();
        } catch (IOException e) {
            throw new RuntimeException(e);
        }
        try {
            connection.setRequestMethod("POST");
        } catch (ProtocolException e) {
            throw new RuntimeException(e);
        }
        connection.setRequestProperty("Content-type", "application/json");
        connection.setRequestProperty("Accept", "application/json");
        connection.setDoOutput(true);
        return connection;
    }
}


